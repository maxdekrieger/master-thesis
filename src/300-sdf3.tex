% !TEX root = document.tex

\chapter{\label{chap:sdf3}WebDSL in SDF3}

  \section{Introduction to SDF3}

    Able to declaratively specify the complete syntax of a programming language in SDF3, and a parser, highlighter and pretty-printer gets generated from this specification.

    \subsection{Syntax}

      Lexical sorts, context-free sorts and constructors

    \subsection{Disambiguation}

      Possibilities:
      - Prefer/avoid annotations on constructors (deprecated)
      - Declare priorities of nested constructors
      - Reject keywords
      - Reject nesting of certain constructors
  
  \section{WebDSL Grammar Specification}

    The current implementation of WebDSL is specified in SDF2, the predecessor of SDF3. 

    Reason to switch to SDF3 here:
    - Modern spoofax does not support SDF2 anymore?
    - SDF3 more performant?

  \section{Migration from SDF2 to SDF3}

    Introduction

    \subsection{Preparing the WebDSL SDF2 definition for migration}

      There is a tool to migrate SDF2 specifications to SDF3 specifications but it does not work in all cases. Some work needs to be done to prepare the SDF2 specification for the migration, and some work needs to be done on the resulting SDF3 specification to make sure it is as usable as the old SDF2 specification.

      The SDF2 to SDF3 migration tool does not accept "sorts" sections.

      Alternations must be removed from the SDF2 specification. Solution is to introduce a separate sort for the alternation:

      Before:
      ("B" | "C") -> A {cons("A")}

      After:
      BorC -> A    {cons("A")}
      "B"  -> BorC {cons("B")}
      "C"  -> BorC {cons("C")}

      Restrictions (both context-free and lexical) produce an error during transformation and must be manually copied.

      Mixed languages and parameterized imports are currently not supported in SDF3, so WebDSL code cannot be mixed with Stratego/Java code in the new SDF3 syntax definition.

      Mixed languages were only used in the compiler, but HQL was also defined as a separate language and this is needed in WebDSL code. Fortunately, the HQL syntax is not used elsewhere and could be transformed to be a part of the WebDSL syntax natively.

    \subsection{Manual Tweaking of Generated WebDSL SDF3}

      \begin{itemize}
        \item Duplicate constructors, normalize constructors with Stratego desugaring
        \item Priority chains are not transferred
        \item Comments removed
        \item Implement templates for pretty-printing
        \item Merge syntax definition of previously mixed HQL
      \end{itemize}

  \section{Preparation for Statix}

    With the intention to use Statix for implementing the WebDSL static analyses, the grammar sorts and constructors have strict requirements. Statix is a strongly typed language and requires all input to adhere to the declared sorts and constructors.

    \subsection{Sorts and Constructors in Statix}

      \begin{itemize}
        \item Syntax
        \item Usage in rules
        \item Difference from SDF3
      \end{itemize}

    \subsection{Statix Signature Generator}

      \begin{itemize}
        \item Conversion from SDF3 constructors to Statix
        \item Optional sorts
        \item Injections
        \item Disambiguation (ref to separate section)
      \end{itemize}

    \subsection{Changing the SDF3 WebDSL Specification}

      \begin{itemize}
        \item Lots of new sorts due to explicit optional sorts
        \item Desugar new optional sorts
        \item Add more constructors for the removal of injections
      \end{itemize}

  \section{Disambiguation}
  
    Since the \texttt{amb(\_,\_)} constructor is not declarable in Statix, having an ambiguity in the AST leads to the analysis not executing. This increases the need for disambiguation.

    Challenges and solutions:
    \begin{itemize}
      \item Keywords in WebDSL: SDF3 template options not optimal.
      \item String interpolation: Convert to one String constructor with a list of parts.
      \item Optional separators: In SDF2 multiple productions could have the same constructor, in SDF3 multiple constructors make for an increase in reject and desugaring rules.
      \item Optional alias vs. cast expression: use non-transitive priority rule.
    \end{itemize}

  \section{Reflection on SDF3}
